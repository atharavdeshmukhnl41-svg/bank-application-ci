trigger:
  branches:
    include:
      - main  
  paths:
    include:
      - $(System.DefaultWorkingDirectory)/bank_application_ci/services

pool:
  name: azureagent

variables:
  ACR_NAME: 'myacrname'
  ACR_LOGIN_SERVER: 'myacrname.azurecr.io'
  TAG: $(Build.BuildId)

stages:

# ===============================
# Stage 1: Build/Package Microservices
# ===============================
- stage: Build
  displayName: Build/Package Microservices
  jobs:
  - ${{ each svc in parameters.CHANGED_SERVICES }}:
      - job: Build_${{ svc }}
        displayName: Build ${{ svc }}
        variables:
          SERVICE_NAME: ${{ svc }}
        steps:
        - checkout: self

        # Example for Java Maven microservices
        - task: Maven@3
          displayName: Build ${{ svc }} (Maven Package)
          inputs:
            mavenPomFile: 'services/${{ svc }}/pom.xml'
            goals: 'clean package'
            options: '-DskipTests'

        # For Node.js microservices, use:
        # - task: Npm@1
        #   displayName: Build ${{ svc }} (Node.js)
        #   inputs:
        #     command: 'install'
        #     workingDir: 'services/${{ svc }}'

# ===============================
# Stage 2: Unit Tests
# ===============================
- stage: Test
  displayName: Unit Test Microservices
  dependsOn: Build
  jobs:
  - ${{ each svc in parameters.CHANGED_SERVICES }}:
      - job: Test_${{ svc }}
        displayName: Test ${{ svc }}
        variables:
          SERVICE_NAME: ${{ svc }}
        steps:
        - checkout: self

        # Maven test task
        - task: Maven@3
          displayName: Run Unit Tests ${{ svc }}
          inputs:
            mavenPomFile: 'services/${{ svc }}/pom.xml'
            goals: 'test'

        # Node.js test example
        # - task: Npm@1
        #   displayName: Run Tests ${{ svc }}
        #   inputs:
        #     command: 'custom'
        #     workingDir: 'services/${{ svc }}'
        #     customCommand: 'test'

# ===============================
# Stage 3: Code Scan (SonarCloud)
# ===============================
- stage: CodeScan
  displayName: Code Scan
  dependsOn: Test
  jobs:
  - ${{ each svc in parameters.CHANGED_SERVICES }}:
      - job: Sonar_${{ svc }}
        displayName: SonarCloud Scan ${{ svc }}
        steps:
        - checkout: self
        - task: SonarCloudPrepare@1
          inputs:
            SonarCloud: 'MySonarServiceConnection'
            organization: 'my-org'
            scannerMode: 'CLI'
            configMode: 'manual'
            cliProjectKey: '${{ svc }}'
            cliSources: 'services/${{ svc }}'
        - task: SonarCloudAnalyze@1
        - task: SonarCloudPublish@1

# ===============================
# Stage 4: Docker Build
# ===============================
- stage: DockerBuild
  displayName: Docker Build
  dependsOn: CodeScan
  jobs:
  - ${{ each svc in parameters.CHANGED_SERVICES }}:
      - job: DockerBuild_${{ svc }}
        displayName: Build Docker Image ${{ svc }}
        steps:
        - checkout: self
        - task: DockerInstaller@0
        - task: Docker@2
          inputs:
            command: build
            Dockerfile: services/${{ svc }}/Dockerfile
            buildContext: services/${{ svc }}
            tags: $(TAG)

# ===============================
# Stage 5: Docker Scan
# ===============================
- stage: DockerScan
  displayName: Docker Image Scan
  dependsOn: DockerBuild
  jobs:
  - ${{ each svc in parameters.CHANGED_SERVICES }}:
      - job: DockerScan_${{ svc }}
        displayName: Trivy Scan ${{ svc }}
        steps:
        - checkout: self
        - task: Trivy@0
          inputs:
            command: 'image'
            imageName: '$(TAG)'
            failOnSeverity: 'HIGH'
            format: 'table'

# ===============================
# Stage 6: Push to ACR
# ===============================
- stage: PushToACR
  displayName: Push Docker Images
  dependsOn: DockerScan
  jobs:
  - ${{ each svc in parameters.CHANGED_SERVICES }}:
      - job: Push_${{ svc }}
        displayName: Push ${{ svc }} to ACR
        steps:
        - checkout: self
        - task: Docker@2
          displayName: Login to ACR
          inputs:
            command: login
            containerRegistry: 'my-acr-service-connection'
        - task: Docker@2
          displayName: Tag Image for ACR
          inputs:
            command: tag
            arguments: $(TAG)
            tags: $(ACR_LOGIN_SERVER)/${{ svc }}:$(TAG)
            containerRegistry: 'my-acr-service-connection'
        - task: Docker@2
          displayName: Push Image
          inputs:
            command: push
            tags: $(ACR_LOGIN_SERVER)/${{ svc }}:$(TAG)
            containerRegistry: 'my-acr-service-connection'